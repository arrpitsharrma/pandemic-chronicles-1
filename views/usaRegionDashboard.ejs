<%- include('./partials/header.ejs') %>
<%- include('./partials/header_dashboard.ejs') %>
<style>
#chartdiv {
  width: 70%;
  height: 600px;
  padding: 0 0 0 0;
}
.worldMapContainer{
    display: inline-block;
    text-align: center;
    width: 100%;
    height: 80%;
    padding: 15px 0 0 0;
    overflow: hidden;
    background-size: cover;
    display: flex;
  align-items: center;
  justify-content: center;
    color: black;
}
</style>

<h4 style="text-align: center; padding-top: 10px;">USA Region-wise Deaths<br><span style="font-size: 12px; color: gray;">Source: https://corona.lmao.ninja/v2/states</span></h4>
<div class="worldMapContainer">
<div id="chartdiv"></div>
</div>

<script>
  if ($('.nav-item').hasClass('active')) {
    $('.nav-item').removeClass('active');
    $('#dashboardNav').addClass('active');
  }
</script>

<!-- Resources -->
<script src="https://code.jquery.com/jquery-3.5.0.min.js"
    integrity="sha256-xNzN2a4ltkB44Mc/Jz3pT4iU1cmeR0FkXs4pru/JxaQ=" crossorigin="anonymous"></script>
<script src="https://www.amcharts.com/lib/4/core.js"></script>
<script src="https://www.amcharts.com/lib/4/charts.js"></script>
<script src="https://www.amcharts.com/lib/4/themes/material.js"></script>
<script src="https://www.amcharts.com/lib/4/themes/animated.js"></script>

<!-- Chart code -->
<script>
$("#btn-usa-region").addClass('active');
var settings = {
    "url": "https://corona.lmao.ninja/v2/states?sort&yesterday",
    "async": true,
    "method": "GET",
    "timeout": 0
  };

$.ajax(settings).done(function (response) { 

am4core.ready(function() {

// Themes begin
am4core.useTheme(am4themes_material);
am4core.useTheme(am4themes_animated);
// Themes end

// Create chart instance
var chart = am4core.create("chartdiv", am4charts.XYChart);

var newdata = response;
var map = [];

//_.keys(_.countBy(data, function(data) { return data.name; }));
        for (item in newdata) {
			if(newdata[item].state === "North Dakota"){
			
				var jsonobject =
                  {"region":"Central",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths };
                  //"value":covid[item].cases, 
                  //"color": worldchart.colors.getIndex(0)};
            map.push(jsonobject);
			} else if(newdata[item].state === "South Dakota"){
				var jsonobject =
                  {"region":"Central",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths };
				  map.push(jsonobject);
			} else if(newdata[item].state === "Kansas"){
				var jsonobject =
                  {"region":"Central",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths };
				  map.push(jsonobject);				  
            } else if(newdata[item].state === "Iowa"){
				var jsonobject =
                  {"region":"Central",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Nebraska"){
				var jsonobject =
                  {"region":"Central",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths };
					map.push(jsonobject);
            } else if(newdata[item].state === "Oklahoma"){
				var jsonobject =
                  {"region":"Central",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Missouri"){
				var jsonobject =
                  {"region":"Central",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Minnesota"){
				var jsonobject =
                  {"region":"Central",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Wisconsin"){
				var jsonobject =
                  {"region":"Central",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Indiana"){
				var jsonobject =
                  {"region":"Central",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
            } else if(newdata[item].state === "Michigan"){
				var jsonobject =
                  {"region":"Central",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Illinois"){
				var jsonobject =
                  {"region":"Central",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Texas"){
				var jsonobject =
                  {"region":"Central",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "West Virginia"){
				var jsonobject =
                  {"region":"East",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Maine"){
				var jsonobject =
                  {"region":"East",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "District of Columbia"){
				var jsonobject =
                  {"region":"East",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "New Hampshire"){
				var jsonobject =
                  {"region":"East",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Vermont"){
				var jsonobject =
                  {"region":"East",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Connecticut"){
				var jsonobject =
                  {"region":"East",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Rhode Island"){
				var jsonobject =
                  {"region":"East",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Maryland"){
				var jsonobject =
                  {"region":"East",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Delaware"){
				var jsonobject =
                  {"region":"East",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Massachusetts"){
				var jsonobject =
                  {"region":"East",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "New Jersey"){
				var jsonobject =
                  {"region":"East",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Ohio"){
				var jsonobject =
                  {"region":"East",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Pennsylvania"){
				var jsonobject =
                  {"region":"East",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "New York"){
				var jsonobject =
                  {"region":"East",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "South Carolina"){
				var jsonobject =
                  {"region":"South",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Louisiana"){
				var jsonobject =
                  {"region":"South",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Mississippi"){
				var jsonobject =
                  {"region":"South",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Arkansas"){
				var jsonobject =
                  {"region":"South",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Alabama"){
				var jsonobject =
                  {"region":"South",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Tennessee"){
				var jsonobject =
                  {"region":"South",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Kentucky"){
				var jsonobject =
                  {"region":"South",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Georgia"){
				var jsonobject =
                  {"region":"South",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "North Carolina"){
				var jsonobject =
                  {"region":"South",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Virginia"){
				var jsonobject =
                  {"region":"South",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Florida"){
				var jsonobject =
                  {"region":"South",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
            } else if(newdata[item].state === "Wyoming"){
				var jsonobject =
                  {"region":"West",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
			} else if(newdata[item].state === "Idaho"){
				var jsonobject =
                  {"region":"West",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
			} else if(newdata[item].state === "New Mexico"){
				var jsonobject =
                  {"region":"West",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
			} else if(newdata[item].state === "Montana"){
				var jsonobject =
                  {"region":"West",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
			} else if(newdata[item].state === "Utah"){
				var jsonobject =
                  {"region":"West",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
			} else if(newdata[item].state === "Nevada"){
				var jsonobject =
                  {"region":"West",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
			} else if(newdata[item].state === "Oregon"){
				var jsonobject =
                  {"region":"West",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
			} else if(newdata[item].state === "Colorado"){
				var jsonobject =
                  {"region":"West",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
			} else if(newdata[item].state === "Arizona"){
				var jsonobject =
                  {"region":"West",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
			} else if(newdata[item].state === "Washington"){
				var jsonobject =
                  {"region":"West",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
			} else if(newdata[item].state === "Wyoming"){
				var jsonobject =
                  {"region":"West",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
			} else if(newdata[item].state === "California"){
				var jsonobject =
                  {"region":"West",
				  "state":newdata[item].state, 
                  "deaths":newdata[item].deaths }; 
				  map.push(jsonobject);
			} 
		}	
			map.sort((a, b) => (a.region > b.region) ? 1 : -1)
          console.log(map);
          chart.data = map;
// Add data

// Create axes
var yAxis = chart.yAxes.push(new am4charts.CategoryAxis());
yAxis.dataFields.category = "state";
yAxis.renderer.grid.template.location = 0;
yAxis.renderer.labels.template.fontSize = 10;
yAxis.renderer.minGridDistance = 10;

var xAxis = chart.xAxes.push(new am4charts.ValueAxis());
// Create series
var series = chart.series.push(new am4charts.ColumnSeries());
series.dataFields.valueX = "deaths";
series.dataFields.categoryY = "state";
series.columns.template.tooltipText = "{categoryY}: [bold]{valueX}[/]";
series.columns.template.strokeWidth = 0;
series.columns.template.adapter.add("fill", function(fill, target) {
  if (target.dataItem) {
    switch(target.dataItem.dataContext.region) {
      case "Central":
        return chart.colors.getIndex(0);
        break;
      case "East":
        return chart.colors.getIndex(1);
        break;
      case "South":
        return chart.colors.getIndex(2);
        break;
      case "West":
        return chart.colors.getIndex(3);
        break;
    }
  }
  return fill;
});

var axisBreaks = {};
var legendData = [];

// Add ranges
function addRange(label, start, end, color) {
  var range = yAxis.axisRanges.create();
 
  range.category = start;
  range.endCategory = end;
  range.label.text = label;
  range.label.disabled = false;
  range.label.fill = color;
  range.label.location = 0;
  range.label.dx = -115;
  range.label.dy = 12;
  range.label.fontWeight = "bold";
  range.label.fontSize = 14;
  range.label.horizontalCenter = "left"
  range.label.inside = true;
  
  range.grid.stroke = am4core.color("#396478");
  range.grid.strokeOpacity = 1;
  range.tick.length = 200;
  range.tick.disabled = false;
  range.tick.strokeOpacity = 0.6;
  range.tick.stroke = am4core.color("#396478");
  range.tick.location = 0;
  
  range.locations.category = 1;
  var axisBreak = yAxis.axisBreaks.create();
  axisBreak.startCategory = start;
  axisBreak.endCategory = end;
  axisBreak.breakSize = 1;
  axisBreak.fillShape.disabled = true;
  axisBreak.startLine.disabled = true;
  axisBreak.endLine.disabled = true;
  axisBreaks[label] = axisBreak;  

  legendData.push({name:label, fill:color});
}

addRange("Central", "Illinois", "North Dakota", chart.colors.getIndex(0));
addRange("East", "New York", "Vermont", chart.colors.getIndex(1));
addRange("South", "Florida", "Arkansas", chart.colors.getIndex(2));
addRange("West", "California", "Wyoming", chart.colors.getIndex(3));

chart.cursor = new am4charts.XYCursor();


var legend = new am4charts.Legend();
legend.position = "right";
legend.scrollable = true;
legend.valign = "top";
legend.reverseOrder = true;

chart.legend = legend;
legend.data = legendData;

legend.itemContainers.template.events.on("toggled", function(event){
  var name = event.target.dataItem.dataContext.name;
  var axisBreak = axisBreaks[name];
  if(event.target.isActive){
    axisBreak.animate({property:"breakSize", to:0}, 1000, am4core.ease.cubicOut);
    yAxis.dataItems.each(function(dataItem){
      if(dataItem.dataContext.region == name){
        dataItem.hide(1000, 500);
      }
    })
    series.dataItems.each(function(dataItem){
      if(dataItem.dataContext.region == name){
        dataItem.hide(1000, 0, 0, ["valueX"]);
      }
    })    
  }
  else{
    axisBreak.animate({property:"breakSize", to:1}, 1000, am4core.ease.cubicOut);
    yAxis.dataItems.each(function(dataItem){
      if(dataItem.dataContext.region == name){
        dataItem.show(1000);
      }
    })  

    series.dataItems.each(function(dataItem){
      if(dataItem.dataContext.region == name){
        dataItem.show(1000, 0, ["valueX"]);
      }
    })        
  }
})

});
}); 

</script>