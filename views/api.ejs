<html>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

<body>
    <!-- <div id="display"></div> -->

    <style>
        #chartdiv {
            width: 100%;
            height: 500px;
        }
    </style>

    <!-- Resources -->
    <script src="https://www.amcharts.com/lib/4/core.js"></script>
    <script src="https://www.amcharts.com/lib/4/charts.js"></script>
    <script src="https://www.amcharts.com/lib/4/maps.js"></script>
    <script src="https://www.amcharts.com/lib/4/geodata/usaAlbersLow.js"></script>
    <script src="https://www.amcharts.com/lib/4/themes/material.js"></script>
    <script src="https://www.amcharts.com/lib/4/themes/animated.js"></script>

    <!-- Chart code -->
    <script>
        var settings = {
            "url": "https://covidtracking.com/api/us/daily",
            "async": true,
            "method": "GET",
            "timeout": 0
        };
        $.ajax(settings).done(function (response) {

            am4core.ready(function () {

                // Themes begin
                am4core.useTheme(am4themes_material);
                am4core.useTheme(am4themes_animated);
                // Themes end

                var mainContainer = am4core.create("chartdiv", am4core.Container);
                mainContainer.width = am4core.percent(100);
                mainContainer.height = am4core.percent(100);
                mainContainer.layout = "horizontal";

                var res;
                var arr = [];
                res = response;
                for (var i = 0; i < res.length; i += 5) {
                    var obj = {};
                    obj['date'] = res[i].date;
                    obj['cases'] = res[i].positive;
                    obj['deaths'] = res[i].death;
                    arr.push(obj);
                }

                var usData = arr;

                var casesChart = mainContainer.createChild(am4charts.XYChart);
                casesChart.paddingRight = 0;
                casesChart.data = JSON.parse(JSON.stringify(usData));

                // Create axes
                var casesCategoryAxis = casesChart.yAxes.push(new am4charts.CategoryAxis());
                casesCategoryAxis.dataFields.category = "date";
                casesCategoryAxis.renderer.grid.template.location = 0;
                //casesCategoryAxis.renderer.inversed = true;
                casesCategoryAxis.renderer.minGridDistance = 15;

                var casesValueAxis = casesChart.xAxes.push(new am4charts.ValueAxis());
                casesValueAxis.renderer.inversed = true;
                casesValueAxis.min = 0;
                casesValueAxis.max = 30;
                casesValueAxis.strictMinMax = true;

                casesValueAxis.numberFormatter = new am4core.NumberFormatter();
                casesValueAxis.numberFormatter.numberFormat = "#.#'%'";

                // Create series
                var casesSeries = casesChart.series.push(new am4charts.ColumnSeries());
                casesSeries.dataFields.valueX = "cases";
                casesSeries.dataFields.valueXShow = "percent";
                casesSeries.calculatePercent = true;
                casesSeries.dataFields.categoryY = "date";
                casesSeries.interpolationDuration = 1000;
                casesSeries.columns.template.tooltipText = "Cases: {valueX} ({valueX.percent.formatNumber('#.0')}%)";
                //casesSeries.sequencedInterpolation = true;


                var deathsChart = mainContainer.createChild(am4charts.XYChart);
                deathsChart.paddingLeft = 0;
                deathsChart.data = JSON.parse(JSON.stringify(usData));

                // Create axes
                var deathsCategoryAxis = deathsChart.yAxes.push(new am4charts.CategoryAxis());
                deathsCategoryAxis.renderer.opposite = true;
                deathsCategoryAxis.dataFields.category = "date";
                deathsCategoryAxis.renderer.grid.template.location = 0;
                deathsCategoryAxis.renderer.minGridDistance = 15;

                var deathsValueAxis = deathsChart.xAxes.push(new am4charts.ValueAxis());
                deathsValueAxis.min = 0;
                deathsValueAxis.max = 30;
                deathsValueAxis.strictMinMax = true;
                deathsValueAxis.numberFormatter = new am4core.NumberFormatter();
                deathsValueAxis.numberFormatter.numberFormat = "#.#'%'";
                deathsValueAxis.renderer.minLabelPosition = 0.01;

                // Create series
                var deathsSeries = deathsChart.series.push(new am4charts.ColumnSeries());
                deathsSeries.dataFields.valueX = "deaths";
                deathsSeries.dataFields.valueXShow = "percent";
                deathsSeries.calculatePercent = true;
                deathsSeries.fill = deathsChart.colors.getIndex(4);
                deathsSeries.stroke = deathsSeries.fill;
                //deathsSeries.sequencedInterpolation = true;
                deathsSeries.columns.template.tooltipText = "Deaths: {valueX} ({valueX.percent.formatNumber('#.0')}%)";
                deathsSeries.dataFields.categoryY = "date";
                deathsSeries.interpolationDuration = 1000;


                var mapChart = mainContainer.createChild(am4maps.MapChart);
                mapChart.projection = new am4maps.projections.Mercator();
                mapChart.geodata = am4geodata_usaAlbersLow;
                mapChart.zoomControl = new am4maps.ZoomControl();
                mapChart.zIndex = -1;

                var polygonSeries = mapChart.series.push(new am4maps.MapPolygonSeries())
                polygonSeries.useGeodata = true;

                var selectedStateId = "US";
                var selectedPolygon;
                var selectedStateName;

                var polygonTemplate = polygonSeries.mapPolygons.template;
                polygonTemplate.togglable = true;

                var hoverState = polygonTemplate.states.create("hover");
                hoverState.properties.fill = mapChart.colors.getIndex(2);

                var activeState = polygonTemplate.states.create("active");
                activeState.properties.fill = mapChart.colors.getIndex(6);

                polygonTemplate.events.on("hit", function (event) {
                    var id = event.target.dataItem.dataContext.id;
                    var stateId = id.split("-")[1];
                    showState(stateId, event.target.dataItem.dataContext.name, event.target);
                })


                mapChart.seriesContainer.background.events.on("over", function (event) {
                    showState(selectedStateId, selectedStateName, selectedPolygon);
                });


                function showState(id, stateName, polygon) {
                    if (selectedStateId != id) {

                        var newData = stateData[id];
                        if (newData === undefined) {

                        }
                        if (selectedPolygon) {
                            selectedPolygon.isActive = false;
                        }

                        for (var i = 0; i < deathsChart.data.length; i++) {
                            deathsChart.data[i].deaths = (newData[i] === undefined) ? 0 : newData[i].deaths;
                            casesChart.data[i].cases = (newData[i] === undefined) ? 0 : newData[i].cases;
                        }

                        deathsChart.invalidateRawData();
                        casesChart.invalidateRawData();

                        selectedStateName = stateName;
                        selectedStateId = id;
                        selectedPolygon = polygon;

                        label.text = stateName + " COVID 19 Impact";
                        label.hide(0);
                        label.show();
                    }
                }

                var label = mainContainer.createChild(am4core.Label);
                label.isMeasured = false;
                label.x = am4core.percent(80);
                label.horizontalCenter = "middle";
                label.y = 50;
                label.showOnInit = true;
                label.text = "US COVID 19 Pyramid";
                label.hiddenState.properties.dy = -100;

                var settings = {
                    "url": "https://covidtracking.com/api/states/daily",
                    "async": true,
                    "method": "GET",
                    "timeout": 0
                };
                var res;
                var mainMap = {};
                $.ajax(settings).done(function (response) {
                    res = response;

                    for (var i = 0; i < res.length; i += 5) {
                        obj = {};
                        var arr = [];
                        obj['date'] = res[i].date;
                        obj['cases'] = res[i].positive;
                        obj['deaths'] = res[i].death;
                        arr.push(obj);
                        if (res[i].state in mainMap) {
                            mainMap[res[i].state] = mainMap[res[i].state].concat(arr)
                        }
                        else {
                            mainMap[res[i].state] = arr
                        }
                    }
                });

                var stateData = mainMap;
            }); // end am4core.ready()
        });
    </script>

    <!-- HTML -->
    <div id="chartdiv"></div>
</body>

</html>